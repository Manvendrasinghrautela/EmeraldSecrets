{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
{% endblock %}

{% block content %}
<div class="product-detail-section">
    <div class="product-detail-grid">
        <!-- Product Gallery -->
        <div class="product-gallery">
            <div class="main-image">
                {% if product.main_image %}
                <img id="main-image" src="{{ product.main_image.url }}" alt="{{ product.name }}">
                {% else %}
                <img id="main-image" src="{% static 'images/placeholder.png' %}" alt="No image">
                {% endif %}
            </div>
            <div class="thumbnail-images">
                <!-- Main product image as first thumbnail -->
                {% if product.main_image %}
                <div class="thumbnail active" onclick="changeImage('{{ product.main_image.url }}')">
                    <img src="{{ product.main_image.url }}" alt="Main">
                </div>
                {% endif %}
                
                <!-- Additional images from gallery -->
                {% for image in product.images.all %}
                <div class="thumbnail" onclick="changeImage('{{ image.image.url }}')">
                    <img src="{{ image.image.url }}" alt="{{ image.alt_text|default:'Gallery image' }}">
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Product Details -->
        <div class="product-details-info">
            <h1>{{ product.name }}</h1>

            <div class="product-meta">
                <div class="product-rating">
                    <span class="stars">
                        {% for i in "12345" %}
                            {% if forloop.counter <= average_rating %}★{% else %}☆{% endif %}
                        {% endfor %}
                    </span>
                    <span class="rating-count">({{ review_count }} reviews)</span>
                </div>
                {% if product.sku %}
                <div style="color: #6c757d;">SKU: {{ product.sku }}</div>
                {% endif %}
                <div style="color: #6c757d;">Stock: {{ product.stock }} items available</div>
            </div>

            <div class="product-description">
                <p>{{ product.short_description|default:product.description|truncatewords:50 }}</p>
            </div>

            <!-- Features -->
            {% if product.benefits %}
            <div class="product-features">
                <h3>Key Features</h3>
                <ul>
                    {% for benefit in product.benefits.splitlines %}
                    {% if benefit.strip %}
                    <li>{{ benefit }}</li>
                    {% endif %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Price Section -->
            <div style="background-color: #f8f9fa; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
                <div style="font-size: 0.875rem; color: #6c757d; margin-bottom: 0.5rem;">Price</div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-size: 2.5rem; font-weight: 700; color: #2D5F3F;">₹{{ product.price }}</span>
                    {% if product.compare_at_price %}
                    <span style="font-size: 1.25rem; color: #6c757d; text-decoration: line-through;">₹{{ product.compare_at_price }}</span>
                    <span style="background-color: #E74C3C; color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;">
                        Save {{ product.discount_percentage }}%
                    </span>
                    {% endif %}
                </div>
            </div>

            <!-- Quantity Selector -->
            <div class="quantity-selector">
                <label>Quantity:</label>
                <div class="quantity-controls">
                    <button class="quantity-btn" onclick="decreaseQuantity()">−</button>
                    <input type="number" class="quantity-input" id="quantity" value="1" min="1" max="{{ product.stock }}">
                    <button class="quantity-btn" onclick="increaseQuantity()">+</button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="add-to-cart-section">
                <!-- Add to Cart Form -->
                <form method="post" action="{% url 'products:add_to_cart' product.id %}" style="flex: 1;">
                    {% csrf_token %}
                    <input type="hidden" name="quantity" id="cart-quantity" value="1">
                    <button type="submit" class="btn btn-primary btn-large" style="width: 100%;">
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                    </button>
                </form>

                <!-- Wishlist Form -->
                <form method="post" action="{% url 'products:wishlist_toggle' product.id %}" style="flex: 1;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline btn-large" style="width: 100%;">
                        <i class="{% if is_wishlist %}fas{% else %}far{% endif %} fa-heart"></i> 
                        {% if is_wishlist %}In Wishlist{% else %}Add to Wishlist{% endif %}
                    </button>
                </form>
            </div>

            <!-- Product Info -->
            <div style="background-color: #f8f9fa; padding: 1.5rem; border-radius: 12px; display: flex; gap: 2rem; margin-bottom: 2rem;">
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;"><i class="fas fa-shipping-fast"></i> Free Shipping</div>
                    <p style="font-size: 0.875rem; color: #6c757d;">On orders over ₹500</p>
                </div>
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;"><i class="fas fa-redo"></i> Easy Returns</div>
                    <p style="font-size: 0.875rem; color: #6c757d;">30-day return policy</p>
                </div>
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;"><i class="fas fa-shield-alt"></i> Secure Payment</div>
                    <p style="font-size: 0.875rem; color: #6c757d;">100% safe transactions</p>
                </div>
            </div>

            <!-- Sharing -->
            <div style="border-top: 1px solid #e5e5e5; padding-top: 2rem;">
                <p style="margin-bottom: 1rem; font-weight: 600;">Share This Product:</p>
                <div style="display: flex; gap: 1rem;">
                    <a href="#" style="width: 40px; height: 40px; border-radius: 50%; background-color: #2D5F3F; color: white; display: flex; align-items: center; justify-content: center;">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="#" style="width: 40px; height: 40px; border-radius: 50%; background-color: #2D5F3F; color: white; display: flex; align-items: center; justify-content: center;">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" style="width: 40px; height: 40px; border-radius: 50%; background-color: #2D5F3F; color: white; display: flex; align-items: center; justify-content: center;">
                        <i class="fab fa-pinterest"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Tabs -->
    <div class="product-tabs">
        <div class="tab-headers">
            <button class="tab-header active" onclick="openTab(event, 'description')">Description</button>
            <button class="tab-header" onclick="openTab(event, 'ingredients')">Ingredients</button>
            <button class="tab-header" onclick="openTab(event, 'reviews')">Reviews ({{ review_count }})</button>
        </div>

        <div id="description" class="tab-content active">
            <h3 style="margin-bottom: 1rem;">Product Description</h3>
            <p>{{ product.description }}</p>
            
            {% if product.shelf_life %}
            <p style="margin-top: 1rem;"><strong>Shelf Life:</strong> {{ product.shelf_life }}</p>
            {% endif %}
            
            {% if product.origin %}
            <p style="margin-top: 1rem;"><strong>Origin:</strong> {{ product.origin }}</p>
            {% endif %}
        </div>

        <div id="ingredients" class="tab-content">
            <h3 style="margin-bottom: 1rem;">Ingredients</h3>
            {% if product.ingredients %}
            <p>{{ product.ingredients|linebreaks }}</p>
            {% else %}
            <p>Ingredient information coming soon.</p>
            {% endif %}
        </div>

        <div id="reviews" class="tab-content">
            <h3 style="margin-bottom: 2rem;">Customer Reviews ({{ review_count }})</h3>
            
            {% if reviews %}
            <div style="display: flex; flex-direction: column; gap: 2rem;">
                {% for review in reviews %}
                <div style="padding: 1.5rem; background-color: #f8f9fa; border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <p style="font-weight: 600;">{{ review.user.get_full_name|default:review.user.username }}</p>
                            <span class="stars">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}★{% else %}☆{% endif %}
                                {% endfor %}
                            </span>
                        </div>
                        <span style="color: #6c757d; font-size: 0.875rem;">{{ review.created_at|date:"d M Y" }}</span>
                    </div>
                    {% if review.title %}
                    <h4 style="margin-bottom: 0.5rem;">{{ review.title }}</h4>
                    {% endif %}
                    <p>{{ review.comment }}</p>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>No reviews yet. Be the first to review this product!</p>
            {% endif %}

            <!-- Review Form -->
            {% if user.is_authenticated %}
            <div style="margin-top: 3rem; padding: 2rem; background-color: #f8f9fa; border-radius: 12px;">
                <h4 style="margin-bottom: 1.5rem;">Leave a Review</h4>
                <form method="post" action="{% url 'products:create_review' product.id %}">
                    {% csrf_token %}
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Rating</label>
                            <select name="rating" required style="width: 100%; padding: 0.75rem; border: 1px solid #e5e5e5; border-radius: 8px;">
                                <option value="">Select rating...</option>
                                <option value="5">★★★★★ Excellent</option>
                                <option value="4">★★★★☆ Good</option>
                                <option value="3">★★★☆☆ Average</option>
                                <option value="2">★★☆☆☆ Poor</option>
                                <option value="1">★☆☆☆☆ Terrible</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Title (Optional)</label>
                            <input type="text" name="title" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e5e5; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Your Review</label>
                            <textarea name="comment" required style="width: 100%; padding: 1rem; border: 1px solid #e5e5e5; border-radius: 8px; min-height: 150px;"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Review</button>
                    </div>
                </form>
            </div>
            {% else %}
            <p style="margin-top: 2rem; text-align: center;">
                <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn-outline">Login to leave a review</a>
            </p>
            {% endif %}
        </div>
    </div>

    <!-- Related Products -->
    {% if related_products %}
    <div style="margin-top: 4rem;">
        <h2 style="font-size: 2rem; margin-bottom: 2rem;">Related Products</h2>
        <div class="product-grid">
            {% for related_product in related_products %}
            <div class="product-card">
                <div class="product-image">
                    {% if related_product.main_image %}
                    <img src="{{ related_product.main_image.url }}" alt="{{ related_product.name }}">
                    {% else %}
                    <img src="{% static 'images/placeholder.png' %}" alt="No image">
                    {% endif %}
                </div>
                <div class="product-info">
                    <p class="product-category">{{ related_product.category.name }}</p>
                    <h3 class="product-name">
                        <a href="{% url 'products:product_detail' related_product.slug %}">{{ related_product.name }}</a>
                    </h3>
                    <div class="product-price">
                        <span class="current-price">₹{{ related_product.price }}</span>
                        {% if related_product.compare_at_price %}
                        <span class="original-price">₹{{ related_product.compare_at_price }}</span>
                        {% endif %}
                    </div>
                    <div class="product-actions">
                        <a href="{% url 'products:product_detail' related_product.slug %}" class="btn btn-primary">
                            <i class="fas fa-eye"></i> View
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
function changeImage(src) {
    document.getElementById('main-image').src = src;
    document.querySelectorAll('.thumbnail').forEach(thumb => thumb.classList.remove('active'));
    event.target.closest('.thumbnail').classList.add('active');
}

function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
    }
    tablinks = document.getElementsByClassName("tab-header");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
    }
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}

function increaseQuantity() {
    let qty = document.getElementById('quantity');
    let max = parseInt(qty.getAttribute('max'));
    if (parseInt(qty.value) < max) {
        qty.value = parseInt(qty.value) + 1;
        document.getElementById('cart-quantity').value = qty.value;
    }
}

function decreaseQuantity() {
    let qty = document.getElementById('quantity');
    if (qty.value > 1) {
        qty.value = parseInt(qty.value) - 1;
        document.getElementById('cart-quantity').value = qty.value;
    }
}

// Update hidden cart quantity on page load
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('cart-quantity').value = document.getElementById('quantity').value;
});
</script>
{% endblock %}
